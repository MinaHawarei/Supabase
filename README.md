# Tasks API - Laravel 12 + Supabase Integration

A secure and well-structured REST API built with Laravel 12 that integrates with Supabase Auth (JWT verification) and Supabase Postgres for task management. This backend provides complete CRUD operations for tasks with file upload capabilities using Supabase Storage.

## üìã Table of Contents

- [Project Overview](#project-overview)
- [Tech Stack](#tech-stack)
- [Features](#features)
- [Prerequisites](#prerequisites)
- [Installation & Setup](#installation--setup)
- [Configuration](#configuration)
- [Database Setup](#database-setup)
- [Supabase Setup](#supabase-setup)
- [Running the Application](#running-the-application)
- [API Documentation](#api-documentation)
- [Authentication Flow](#authentication-flow)
- [Storage Upload Flow](#storage-upload-flow)
- [Testing](#testing)
- [Project Structure](#project-structure)

## üéØ Project Overview

This backend API provides task management functionality with the following capabilities:

- **JWT Authentication** via Supabase Auth tokens
- **Task CRUD Operations** with creator/assignee authorization
- **File Uploads** to Supabase Storage (images and PDFs)
- **Signed URLs** for secure file access
- **PostgreSQL Database** hosted on Supabase

The frontend (React) handles user authentication using Supabase Auth and sends the access token with each API request. The backend verifies the JWT token using Supabase's JWKS endpoint.

## üõ† Tech Stack

- **PHP**: 8.5+
- **Laravel**: 12.x
- **PostgreSQL**: Supabase Postgres
- **Authentication**: Supabase Auth (JWT)
- **Storage**: Supabase Storage
- **JWT Library**: lcobucci/jwt

## ‚ú® Features

- ‚úÖ JWT verification middleware with JWKS validation and caching
- ‚úÖ Complete CRUD operations for tasks
- ‚úÖ File upload support (JPEG, PNG, PDF) up to 10MB
- ‚úÖ Signed URLs for secure file access (60-second expiration)
- ‚úÖ Authorization rules (creator/assignee based)
- ‚úÖ Task filtering by priority and due date
- ‚úÖ Pagination support
- ‚úÖ Comprehensive error handling
- ‚úÖ Production-ready code structure

## üì¶ Prerequisites

Before you begin, ensure you have the following installed:

- PHP 8.5 or higher
- Composer
- PostgreSQL client (for database access)
- Supabase account with a project created
- Node.js and npm (for asset compilation, if needed)

## üöÄ Installation & Setup

### 1. Clone the Repository

```bash
git clone <repository-url>
cd Supabase-task
```

### 2. Install Dependencies

```bash
composer install
npm install  # Optional: Only if you need frontend assets
```

### 3. Environment Configuration

Copy the `.env.example` file to `.env`:

```bash
cp .env.example .env
```

Generate the application key:

```bash
php artisan key:generate
```

### 4. Configure Environment Variables

Edit your `.env` file and add the following variables:

```env
APP_NAME=TasksApi
APP_ENV=local
APP_KEY=base64:... # Generated by key:generate
APP_DEBUG=true
APP_URL=http://localhost

DB_CONNECTION=pgsql
DB_HOST=<your-supabase-db-host>
DB_PORT=5432
DB_DATABASE=<your-db-name>
DB_USERNAME=<your-db-user>
DB_PASSWORD=<your-db-password>

SUPABASE_URL=https://<project-ref>.supabase.co
SUPABASE_SERVICE_ROLE_KEY=<your-service-role-key>
SUPABASE_BUCKET=attachments
SUPABASE_JWKS_URL=https://<project-ref>.supabase.co/auth/v1/.well-known/jwks.json
```

**Important**: 
- Replace `<project-ref>` with your Supabase project reference
- The `SUPABASE_SERVICE_ROLE_KEY` should be kept secret and never exposed to the frontend
- You can find these values in your Supabase project settings

## üóÑÔ∏è Database Setup

### Option 1: Using Laravel Migration

Run the migration to create the tasks table:

```bash
php artisan migrate
```

### Option 2: Using SQL File (Alternative)

If you prefer to run SQL directly in Supabase, use the provided `database/schema.sql` file:

1. Open your Supabase dashboard
2. Navigate to SQL Editor
3. Copy and paste the contents of `database/schema.sql`
4. Execute the SQL

The schema includes:
- UUID primary keys with auto-generation
- All required fields (creator_id, assignee_id, title, description, etc.)
- Priority enum constraint
- Indexes on assignee_id and due_date

## ‚òÅÔ∏è Supabase Setup

### 1. Create Storage Bucket

1. Go to your Supabase project dashboard
2. Navigate to **Storage** in the sidebar
3. Click **Create a new bucket**
4. Name it `attachments` (or match your `SUPABASE_BUCKET` value)
5. Set it as **Private** (files are accessed via signed URLs)
6. Click **Create bucket**

### 2. Configure Bucket Policies (Optional)

You can configure RLS policies for additional security, but the backend uses the Service Role Key which bypasses RLS.

### 3. Get Your Credentials

1. **Project URL**: Found in your project settings (e.g., `https://xyzabc.supabase.co`)
2. **Service Role Key**: Found in Project Settings ‚Üí API ‚Üí Service Role Key (keep this secret!)
3. **Database Connection**: Found in Project Settings ‚Üí Database ‚Üí Connection string
4. **JWKS URL**: `https://<project-ref>.supabase.co/auth/v1/.well-known/jwks.json`

## üèÉ Running the Application

### Development Server

Start the Laravel development server:

```bash
php artisan serve
```

The API will be available at `http://localhost:8000`

### Queue Worker (if using queues)

```bash
php artisan queue:work
```

## üìö API Documentation

All API endpoints are prefixed with `/api` and require authentication via Bearer token.

### Base URL

```
http://localhost:8000/api
```

### Authentication Header

All requests must include the Authorization header:

```
Authorization: Bearer <SUPABASE_ACCESS_TOKEN>
```

### Endpoints

#### 1. Get Current User

```http
GET /api/me
```

**Response:**
```json
{
  "user_id": "uuid-here",
  "email": "user@example.com"
}
```

#### 2. List Tasks

```http
GET /api/tasks
```

**Query Parameters:**
- `priority` (optional): Filter by priority (`low`, `medium`, `high`)
- `due_date_from` (optional): Filter tasks due from this date
- `due_date_to` (optional): Filter tasks due until this date
- `per_page` (optional): Number of results per page (default: 15, max: 100)
- `page` (optional): Page number

**Response:**
```json
{
  "data": [
    {
      "id": "uuid",
      "creator_id": "uuid",
      "assignee_id": "uuid",
      "title": "Task title",
      "description": "Task description",
      "due_date": "2024-12-31T23:59:59+00:00",
      "priority": "high",
      "is_completed": false,
      "attachment_url": "https://...", // if attachment exists
      "attachment_mime": "image/jpeg", // if attachment exists
      "created_at": "2024-01-01T00:00:00+00:00",
      "updated_at": "2024-01-01T00:00:00+00:00"
    }
  ],
  "links": {...},
  "meta": {...}
}
```

**Authorization**: Returns tasks where user is creator OR assignee

#### 3. Create Task

```http
POST /api/tasks
Content-Type: multipart/form-data
```

**Request Body:**
- `title` (required): Task title (string)
- `assignee_id` (required): UUID of assignee
- `description` (optional): Task description (string)
- `due_date` (required): Due date (ISO 8601 format)
- `priority` (required): Priority level (`low`, `medium`, `high`)
- `attachment` (optional): File upload (JPEG, PNG, PDF, max 10MB)

**Response:**
```json
{
  "id": "uuid",
  "creator_id": "uuid",
  "assignee_id": "uuid",
  "title": "Task title",
  "description": "Task description",
  "due_date": "2024-12-31T23:59:59+00:00",
  "priority": "high",
  "is_completed": false,
  "attachment_url": "https://...", // if attachment was uploaded
  "attachment_mime": "image/jpeg",
  "created_at": "2024-01-01T00:00:00+00:00",
  "updated_at": "2024-01-01T00:00:00+00:00"
}
```

**Status Code**: 201 Created

**Authorization**: Automatically sets `creator_id` to authenticated user

#### 4. Get Task

```http
GET /api/tasks/{id}
```

**Response:**
```json
{
  "id": "uuid",
  "creator_id": "uuid",
  "assignee_id": "uuid",
  "title": "Task title",
  "description": "Task description",
  "due_date": "2024-12-31T23:59:59+00:00",
  "priority": "high",
  "is_completed": false,
  "attachment_url": "https://...", // if attachment exists
  "attachment_mime": "image/jpeg",
  "created_at": "2024-01-01T00:00:00+00:00",
  "updated_at": "2024-01-01T00:00:00+00:00"
}
```

**Authorization**: Only creator or assignee can access (403 Forbidden otherwise)

#### 5. Update Task

```http
PUT /api/tasks/{id}
Content-Type: application/json
```

**Request Body** (all fields optional):
- `title` (optional): Task title
- `description` (optional): Task description
- `due_date` (optional): Due date
- `priority` (optional): Priority level
- `is_completed` (optional): Completion status (boolean)

**Response:**
```json
{
  "id": "uuid",
  "creator_id": "uuid",
  "assignee_id": "uuid",
  "title": "Updated title",
  "description": "Updated description",
  "due_date": "2024-12-31T23:59:59+00:00",
  "priority": "medium",
  "is_completed": true,
  "attachment_url": "https://...",
  "created_at": "2024-01-01T00:00:00+00:00",
  "updated_at": "2024-01-02T00:00:00+00:00"
}
```

**Authorization Rules:**
- Creator or assignee can update title, description, priority, due_date
- Only assignee can set `is_completed = true`
- Returns 403 Forbidden if rules are violated

#### 6. Delete Task

```http
DELETE /api/tasks/{id}
```

**Response:**
```
204 No Content
```

**Authorization**: Only creator can delete (403 Forbidden otherwise)

**Note**: If the task has an attachment, it will be deleted from Supabase Storage automatically.

### Error Responses

All errors follow a consistent format:

```json
{
  "message": "Error message here"
}
```

**Status Codes:**
- `401 Unauthorized`: Invalid or missing JWT token
- `403 Forbidden`: User doesn't have permission for this operation
- `404 Not Found`: Resource not found
- `422 Unprocessable Entity`: Validation error (check validation messages)

## üîê Authentication Flow

### Frontend Flow

1. **User Sign Up / Login**: Frontend uses Supabase Auth SDK to authenticate users
   ```javascript
   const { data, error } = await supabase.auth.signInWithPassword({
     email: 'user@example.com',
     password: 'password'
   });
   ```

2. **Extract Access Token**: After successful authentication, extract the access token
   ```javascript
   const accessToken = data.session.access_token;
   ```

3. **Make API Requests**: Include the token in the Authorization header
   ```javascript
   fetch('http://localhost:8000/api/tasks', {
     headers: {
       'Authorization': `Bearer ${accessToken}`,
       'Content-Type': 'application/json'
     }
   });
   ```

### Backend JWT Verification

The `SupabaseAuth` middleware handles JWT verification:

1. **Extract Token**: Reads the Bearer token from the Authorization header
2. **Fetch JWKS**: Downloads Supabase's JSON Web Key Set (cached for 1 hour)
3. **Validate Signature**: Verifies the JWT signature using the matching key
4. **Check Expiration**: Validates the token hasn't expired
5. **Extract Claims**: Gets user ID (`sub`) and email from token claims
6. **Attach to Request**: Stores user ID in request attributes for controllers

If validation fails at any step, a 401 Unauthorized response is returned.

## üì§ Storage Upload Flow

When a task is created with an attachment:

1. **File Validation**: Validates file type (JPEG, PNG, PDF) and size (max 10MB)
2. **Generate Path**: Creates a unique path: `tasks/{task_id}/{random}_{original_filename}`
3. **Upload to Supabase**: Uses Service Role Key to upload via Supabase Storage REST API
4. **Store Metadata**: Saves `attachment_key` and `attachment_mime` in database
5. **Generate Signed URL**: Creates a signed URL (expires in 60 seconds) for immediate access

**File Access**:
- Signed URLs are generated on-demand when tasks are retrieved
- URLs expire after 60 seconds for security
- Frontend should fetch fresh URLs when displaying attachments

## üîê Row Level Security (RLS)

The application includes Supabase Row Level Security policies for additional database-level protection. These policies work alongside Laravel's application-level authorization.

### Why RLS is Added

RLS provides defense-in-depth security by enforcing access rules at the database level. Even if application code has vulnerabilities, RLS policies ensure users can only access data they're authorized to see.

### RLS Policies

The RLS policies are defined in `database/rls_policies.sql`:

- **SELECT Policy**: Users can view tasks where they are the creator OR assignee
- **INSERT Policy**: Only the creator can insert tasks (creator_id must match authenticated user)
- **UPDATE Policy**: Creator or assignee can update tasks
- **DELETE Policy**: Only creator can delete tasks

### How Laravel Sets JWT Claims

The `SupabaseAuth` middleware automatically sets the JWT user ID in PostgreSQL session variables on each request:

```php
SELECT set_config('request.jwt.claim.sub', <user_id>, true);
```

This allows Supabase's RLS policies to access the authenticated user ID via `auth.uid()` function in the policies. The session variable is set at the beginning of each API request after JWT validation.

### Enabling RLS

To enable RLS policies, run the SQL file in your Supabase SQL Editor:

```sql
-- Run database/rls_policies.sql in Supabase SQL Editor
```

**Note**: The backend also uses Service Role Key for storage operations, which bypasses RLS. This is appropriate for backend administrative operations.

## üß™ Testing

### Manual Testing with Postman

Import the provided `postman_collection.json` file into Postman:

1. Open Postman
2. Click **Import**
3. Select `postman_collection.json`
4. Update the `base_url` variable to match your setup
5. Get an access token from Supabase Auth
6. Set it in the collection's Authorization or individual requests

### Running Tests

```bash
php artisan test
```

Run specific test files:

```bash
php artisan test --filter TaskTest
php artisan test --filter AuthMiddlewareTest
php artisan test --filter TaskAuthorizationTest
php artisan test --filter StorageUploadTest
```

### Feature Tests Included

- **AuthMiddlewareTest**: Tests JWT middleware (missing token, invalid token)
- **TaskAuthorizationTest**: Tests authorization rules (creator can delete, only assignee can complete)
- **StorageUploadTest**: Tests signed upload URL and attachment_key handling

## üìÅ Project Structure

```
app/
‚îú‚îÄ‚îÄ Http/
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Api/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ MeController.php
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ TaskController.php
‚îÇ   ‚îú‚îÄ‚îÄ Middleware/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SupabaseAuth.php
‚îÇ   ‚îî‚îÄ‚îÄ Requests/
‚îÇ       ‚îú‚îÄ‚îÄ StoreTaskRequest.php
‚îÇ       ‚îî‚îÄ‚îÄ UpdateTaskRequest.php
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îî‚îÄ‚îÄ Task.php
‚îî‚îÄ‚îÄ Services/
    ‚îî‚îÄ‚îÄ SupabaseStorageService.php

config/
‚îî‚îÄ‚îÄ services.php (Supabase configuration)

database/
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îî‚îÄ‚îÄ 2025_12_05_231343_create_tasks_table.php
‚îî‚îÄ‚îÄ schema.sql

routes/
‚îî‚îÄ‚îÄ api.php

bootstrap/
‚îî‚îÄ‚îÄ app.php (Middleware registration)
```

## üîß Configuration Details

### Middleware Registration

The `SupabaseAuth` middleware is registered in `bootstrap/app.php`:

```php
$middleware->alias([
    'supabase.auth' => SupabaseAuth::class,
]);
```

All API routes are protected by this middleware.

### Supabase Configuration

Supabase settings are stored in `config/services.php`:

```php
'supabase' => [
    'url' => env('SUPABASE_URL'),
    'service_role_key' => env('SUPABASE_SERVICE_ROLE_KEY'),
    'bucket' => env('SUPABASE_BUCKET', 'attachments'),
    'jwks_url' => env('SUPABASE_JWKS_URL'),
],
```

## üîí Security Considerations

1. **Service Role Key**: Never expose the Service Role Key to the frontend. It bypasses all RLS policies.
2. **JWT Validation**: Tokens are validated on every request with cached JWKS for performance.
3. **Signed URLs**: File access uses short-lived signed URLs (60 seconds) for security.
4. **Authorization**: Strict authorization rules ensure users can only access/modify their own tasks.
5. **File Validation**: File types and sizes are validated before upload.

## üìù Notes

- The JWKS endpoint is cached for 1 hour to reduce API calls
- Signed URLs expire after 60 seconds for security
- Task attachments are automatically deleted when a task is deleted
- Only assignees can mark tasks as completed
- Only creators can delete tasks

## üö® Troubleshooting

### JWT Validation Fails

- Check that `SUPABASE_JWKS_URL` is correctly configured
- Ensure the token is not expired
- Verify the token was issued by your Supabase project

### File Upload Fails

- Verify `SUPABASE_SERVICE_ROLE_KEY` is correct
- Check that the storage bucket exists and is named correctly
- Ensure file size is under 10MB
- Verify file type is JPEG, PNG, or PDF

### Database Connection Issues

- Verify PostgreSQL connection settings in `.env`
- Check that Supabase database is accessible
- Ensure the `pgcrypto` extension is enabled

## üìÑ License

This project is part of a backend assessment.

---

**Built with ‚ù§Ô∏è using Laravel 12 and Supabase**

